#!/bin/sh -e

if [ "$1" = local ]; then
    export PYTHONPATH=.
    export APPORT_CRASHDB_CONF=./crashdb.conf
    basedir=.
    local=1
else
    basedir="/usr/share/python-support/*"
    unset local
fi

mydir=`dirname "$0"`

set -x
python -tt $basedir/problem_report.py -v
python -tt $basedir/apport/fileutils.py -v
python -tt $basedir/apport/report.py -v
python -tt $basedir/apport_python_hook.py -v
python -tt $basedir/apport/ui.py -v
python -tt $basedir/apport/REThread.py -v
python -tt $basedir/apport/chroot.py -v
python -tt $basedir/apport/crashdb_impl/memory.py -v
if [ "$local" ]; then
    python -tt backends/packaging-apt-dpkg.py -v
else
    python -tt $basedir/apport/packaging_impl.py -v
fi

if [ "$local" ]; then
    $mydir/test-hooks -l
else
    $mydir/test-hooks
fi

if [ "`dd if=/proc/sys/kernel/core_pattern count=1 bs=1 2>/dev/null`" = "|" ]; then
    $mydir/test-apport kernel
else
    if [ "$local" ]; then
        $mydir/test-apport lib
    else
        echo 'apport is not enabled; run "sudo /etc/init.d/apport start" to do so' >&2
        exit 1
    fi
fi
