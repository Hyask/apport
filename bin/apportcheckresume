#!/usr/bin/python
import os
import os.path
import sys
import datetime
import commands

import apport.hookutils

def main(argv=None):

    if argv is None:
        argv = sys.argv

    try:
        from apport.packaging_impl import impl as packaging
        if not packaging.enabled():
            return -1

        import apport.report
        pr = apport.report.Report(type='KernelOops')

        libdir = '/var/lib/pm-utils'
        flagfile = libdir + '/status'
        stresslog = libdir + '/stress.log'

        pr.add_os_info()
        pr.add_proc_info()
        pr.add_user_info()
        pr['Package'] = 'linux-image-' + os.uname()[2]
        pr['Originator'] = 'Steve Conklin <sconklin@canonical.com>'

        # grab the contents of the suspend/resume flag file
        apport.hookutils.attach_file(pr, flagfile, 'FlagFile')

        # grab the contents of the suspend/resume stress test log if present.
        apport.hookutils.attach_file(pr, stresslog, 'StressLog')

        # Title the report with suspend or hibernate as appropriate.
        pr['OopsText'] = pr['FlagFile'] + '/resume problem\n'

        pr['Tags'] = 'resume ' + pr['FlagFile']

        if pr.check_ignored():
            return 0

        nowtime = datetime.datetime.now()
        pr_filename = '/var/crash/susres.%s.crash' % (str(nowtime).replace(" ","_"))
        report_file = os.fdopen(os.open(pr_filename, os.O_WRONLY|os.O_CREAT|os.O_EXCL), 'w')
        os.chmod(pr_filename, 0600)
        try:
            pr.write(report_file)
        finally:
            report_file.close()
        return 0
    except:
        print "apportcheckresume failed"
        raise

if __name__ == "__main__":
    sys.exit(main())


